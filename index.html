<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScorpX AI Forex Trading Assistant</title>
  <meta name="description" content="AI-powered Forex scalping assistant with real-time charts, position sizing, and trading signals">
  
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --danger: #ef4444;
      --warning: #eab308;
      --info: #3b82f6;
      --border: rgba(255, 255, 255, 0.1);
      --border-light: rgba(255, 255, 255, 0.05);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --radius: 12px;
      --transition: all 0.2s ease;
      --ai-buy: #10b981;
      --ai-sell: #ef4444;
      --ai-neutral: #6b7280;
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --accent: #16a34a;
      --accent-hover: #15803d;
      --danger: #dc2626;
      --warning: #ca8a04;
      --info: #2563eb;
      --border: rgba(0, 0, 0, 0.1);
      --border-light: rgba(0, 0, 0, 0.05);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      --ai-buy: #059669;
      --ai-sell: #dc2626;
      --ai-neutral: #9ca3af;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    @media (max-width: 1200px) {
      .app {
        grid-template-columns: 1fr;
        max-width: 1000px;
      }
    }

    .main-container {
      display: grid;
      grid-template-rows: auto auto;
      gap: 24px;
    }

    .calculator-container, .ai-assistant-container {
      background: var(--card);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .ai-assistant-container {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(34, 197, 94, 0.02));
      border-left: 4px solid var(--ai-buy);
    }

    .chart-container {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .header {
      margin-bottom: 30px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 6px;
      background: linear-gradient(135deg, var(--accent), var(--info));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      max-width: 700px;
    }

    .theme-toggle {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: var(--border-light);
      border-color: var(--accent);
    }

    /* API Status Indicator */
    .api-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      font-size: 0.75rem;
      margin-top: 10px;
    }

    .api-status.online {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .api-status.offline {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
    }

    .api-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .api-indicator.online {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .api-indicator.offline {
      background: var(--danger);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 8px;
      transition: var(--transition);
    }

    .tab-btn.active {
      background: var(--info);
      color: white;
    }

    .tab-btn:hover:not(.active) {
      background: var(--border-light);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Market Data Refresh Button */
    .refresh-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }

    .refresh-btn:hover {
      background: var(--border-light);
      border-color: var(--accent);
    }

    .refresh-btn.loading {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* Live Market Data Display */
    .market-data {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
      padding: 15px;
      background: var(--border-light);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .market-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 10px;
    }

    .market-symbol {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .market-price {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .market-change {
      font-size: 0.8rem;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .market-change.positive {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent);
    }

    .market-change.negative {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    /* AI Assistant Specific Styles */
    .ai-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .ai-title {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ai-icon {
      font-size: 1.6rem;
    }

    .confidence-meter {
      width: 100%;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
      position: relative;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--danger), var(--warning), var(--accent));
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .confidence-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 5px;
    }

    .confidence-value {
      position: absolute;
      right: 10px;
      top: 0;
      height: 100%;
      display: flex;
      align-items: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .ai-signal {
      padding: 20px;
      border-radius: var(--radius);
      margin: 20px 0;
      text-align: center;
      display: none;
    }

    .ai-signal.buy {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 2px solid var(--ai-buy);
      display: block;
    }

    .ai-signal.sell {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      border: 2px solid var(--ai-sell);
      display: block;
    }

    .ai-signal.no-trade {
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));
      border: 2px solid var(--ai-neutral);
      display: block;
    }

    .signal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .signal-buy { color: var(--ai-buy); }
    .signal-sell { color: var(--ai-sell); }
    .signal-neutral { color: var(--ai-neutral); }

    .ai-parameters {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .param-group {
      background: var(--border-light);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .param-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 5px;
      display: block;
    }

    .param-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }

    .param-value.buy { color: var(--ai-buy); }
    .param-value.sell { color: var(--ai-sell); }

    .ai-results {
      background: var(--border-light);
      padding: 20px;
      border-radius: var(--radius);
      margin-top: 20px;
      border: 1px solid var(--border);
    }

    .ai-result-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .ai-result-item {
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .ai-result-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 5px;
      display: block;
    }

    .ai-result-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .generate-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--info), var(--accent));
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      transition: var(--transition);
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .ai-status {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 0.9rem;
      display: none;
    }

    .ai-status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: var(--accent);
      display: block;
    }

    .ai-status.warning {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.2);
      color: var(--warning);
      display: block;
    }

    .ai-status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
      display: block;
    }

    .ai-status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--info);
      display: block;
    }

    /* Currency badges */
    .currency-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .currency-badge {
      background: var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid transparent;
      cursor: pointer;
      transition: var(--transition);
    }

    .currency-badge:hover {
      background: var(--border-light);
      border-color: var(--accent);
    }

    .currency-badge.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .currency-badge.xau {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .required::after {
      content: "*";
      color: var(--danger);
      margin-left: 2px;
    }

    input, select {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    input::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
    }

    .currency-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      padding: 12px;
      background: var(--border-light);
      border-radius: 8px;
      font-size: 0.875rem;
      flex-wrap: wrap;
    }

    .currency-info .pip {
      font-weight: 600;
      color: var(--accent);
    }

    .currency-info .spread {
      font-weight: 600;
      color: var(--warning);
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border-light);
      border-color: var(--text-muted);
    }

    .btn-chart {
      background: var(--info);
      color: white;
      margin-top: 10px;
    }

    .btn-chart:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .result {
      margin-top: 32px;
      padding: 24px;
      background: var(--border-light);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .result.show {
      display: block;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 640px) {
      .result-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .result-grid {
        grid-template-columns: 1fr;
      }
    }

    .result-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .result-item h3 {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .result-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
    }

    .status {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-size: 0.95rem;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: var(--accent);
    }

    .status.warning {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.2);
      color: var(--warning);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .footer {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .tip {
      background: rgba(34, 197, 94, 0.05);
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid var(--accent);
    }

    .tip strong {
      color: var(--accent);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .input-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
      opacity: 0.8;
    }

    .currency-selector {
      margin-bottom: 20px;
    }

    .currency-selector label {
      margin-bottom: 10px;
      display: block;
    }

    .selected-currency {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--border-light);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .selected-currency .symbol {
      font-weight: 700;
      font-size: 1.2rem;
    }

    .selected-currency .name {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Chart Section */
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .chart-timeframe {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .timeframe-btn {
      padding: 6px 12px;
      background: var(--border);
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.8rem;
      transition: var(--transition);
    }

    .timeframe-btn.active {
      background: var(--info);
      color: white;
    }

    .tradingview-widget {
      width: 100%;
      height: 400px;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 15px;
    }

    .price-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--border-light);
      border-radius: var(--radius);
      margin-top: 15px;
      font-size: 0.9rem;
    }

    .price-change {
      font-weight: 600;
    }

    .price-change.positive {
      color: var(--accent);
    }

    .price-change.negative {
      color: var(--danger);
    }

    .chart-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .chart-type-btn {
      padding: 8px 16px;
      background: var(--border);
      border: none;
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
    }

    .chart-type-btn.active {
      background: var(--info);
      color: white;
    }

    .sync-notice {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 10px;
      text-align: center;
      padding: 8px;
      background: var(--border-light);
      border-radius: 6px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .quick-btn {
      padding: 10px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      text-align: center;
      transition: var(--transition);
    }

    .quick-btn:hover {
      background: var(--border-light);
      border-color: var(--accent);
    }

    /* Apply AI Signal Button */
    .apply-signal-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--ai-buy), var(--info));
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: var(--transition);
    }

    .apply-signal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .apply-signal-btn.sell {
      background: linear-gradient(135deg, var(--ai-sell), #f97316);
    }

    .apply-signal-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Loading Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- TradingView Widget -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body data-theme="dark">
  <div class="app">
    <!-- Left Column: Main Content -->
    <div class="main-container">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="calculator">Position Calculator</button>
        <button class="tab-btn" data-tab="ai-assistant">AI Trading Assistant</button>
        <button class="tab-btn" data-tab="market">Live Market Data</button>
      </div>

      <!-- Calculator Tab -->
      <div class="tab-content active" id="calculator-tab">
        <div class="calculator-container">
          <div class="header">
            <div class="top-bar">
              <div>
                <h1>ScorpX Forex & Gold Scalping Calculator</h1>
                <p class="subtitle">Professional position sizing calculator for major forex pairs and XAU/USD.</p>
                <div class="api-status" id="apiStatus">
                  <span class="api-indicator"></span>
                  <span class="api-status-text">API: Connecting...</span>
                </div>
              </div>
              <div style="display: flex; gap: 10px;">
                <button class="refresh-btn" id="refreshMarketData" title="Refresh market data">
                  <span>‚Üª</span> Refresh
                </button>
                <button class="theme-toggle" id="themeBtn">
                  <span class="theme-icon">üåô</span>
                  <span class="theme-text">Dark Mode</span>
                </button>
              </div>
            </div>

            <div class="currency-badges">
              <div class="currency-badge active" data-currency="EURUSD">EUR/USD</div>
              <div class="currency-badge" data-currency="GBPUSD">GBP/USD</div>
              <div class="currency-badge" data-currency="USDJPY">USD/JPY</div>
              <div class="currency-badge" data-currency="AUDUSD">AUD/USD</div>
              <div class="currency-badge" data-currency="USDCAD">USD/CAD</div>
              <div class="currency-badge" data-currency="USDCHF">USD/CHF</div>
              <div class="currency-badge xau" data-currency="XAUUSD">XAU/USD</div>
            </div>
          </div>

          <div class="currency-selector">
            <label>Selected Instrument:</label>
            <div class="selected-currency" id="selectedCurrency">
              <span class="symbol">EUR/USD</span>
              <span class="name">Euro vs US Dollar</span>
            </div>
          </div>

          <div class="grid">
            <div class="input-group">
              <label for="entry" class="required">Entry Price</label>
              <input 
                type="number" 
                id="entry" 
                step="0.00001" 
                placeholder="e.g., 1.07450"
                min="0.5"
                max="2"
              >
              <div class="input-hint">Current market price for selected instrument</div>
            </div>
            
            <div class="input-group">
              <label for="stop" class="required">Stop Loss Price</label>
              <input 
                type="number" 
                id="stop" 
                step="0.00001" 
                placeholder="e.g., 1.07350"
              >
              <div class="input-hint">Price where you'll exit to limit losses</div>
            </div>
            
            <div class="input-group">
              <label for="take" class="required">Take Profit Price</label>
              <input 
                type="number" 
                id="take" 
                step="0.00001" 
                placeholder="e.g., 1.07600"
              >
              <div class="input-hint">Price where you'll take profits</div>
            </div>
            
            <div class="input-group">
              <label for="balance" class="required">Account Balance (USD)</label>
              <input 
                type="number" 
                id="balance" 
                step="0.01" 
                placeholder="e.g., 10000"
                min="100"
              >
              <div class="input-hint">Your trading account balance in USD</div>
            </div>
            
            <div class="input-group">
              <label for="riskPct" class="required">Risk Per Trade (%)</label>
              <input 
                type="number" 
                id="riskPct" 
                step="0.01" 
                placeholder="e.g., 0.5"
                min="0.01"
                max="5"
                value="0.5"
              >
              <div class="input-hint">Recommended: 0.5% - 2% of account balance</div>
            </div>
            
            <div class="input-group">
              <label for="pipValue">Position Size Type</label>
              <select id="pipValue">
                <option value="10">Standard (1.0 lot = $10/pip)</option>
                <option value="1">Mini (0.1 lot = $1/pip)</option>
                <option value="0.1">Micro (0.01 lot = $0.10/pip)</option>
              </select>
              <div class="input-hint">Select based on your broker account type</div>
            </div>
          </div>

          <div class="currency-info" id="currencyInfo">
            <div><span class="pip">1 pip = 0.0001</span> (4th decimal)</div>
            <div>Typical spread: <span class="spread">0.6-1.2 pips</span></div>
            <div>Trading hours: London-NY overlap (13:00-16:00 GMT)</div>
          </div>

          <div class="actions">
            <button class="btn-primary" id="calcBtn">
              <span>üìä Calculate Position Size</span>
            </button>
            <button class="btn-secondary" id="resetBtn">
              <span>üîÑ Reset All</span>
            </button>
            <button class="btn-chart" id="syncChartBtn">
              <span>üìà Sync with Chart</span>
            </button>
            <button class="refresh-btn" id="fillMarketData" title="Fill with current market price">
              <span>üìä Fill Market Price</span>
            </button>
          </div>

          <div class="result" id="result">
            <h2 style="margin-bottom: 20px; color: var(--text);">Results for <span id="resultCurrency">EUR/USD</span></h2>
            <div class="result-grid">
              <div class="result-item">
                <h3>Pips to Stop Loss</h3>
                <div class="result-value" id="pipsStop">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Pips to Take Profit</h3>
                <div class="result-value" id="pipsTake">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Risk : Reward Ratio</h3>
                <div class="result-value" id="rr">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Risk Amount (USD)</h3>
                <div class="result-value" id="riskUsd">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Position Size (Lots)</h3>
                <div class="result-value" id="lots">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Position Units</h3>
                <div class="result-value" id="units">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="status" id="status"></div>

          <div class="footer">
            <div class="tip">
              <p><strong>üí° Trading Information:</strong></p>
              <p><strong>EUR/USD:</strong> Most liquid pair, best during London/NY overlap (13:00-16:00 GMT)<br>
              <strong>GBP/USD:</strong> High volatility, watch for UK economic news (08:00 GMT)<br>
              <strong>USD/JPY:</strong> Lower spreads, influenced by BOJ and US yields (Tokyo session)<br>
              <strong>XAU/USD:</strong> 1 pip = $0.01, trades 24/5, higher spreads (0.3-0.8), high volatility</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.8rem; opacity: 0.7;">
              Note: Use the AI Trading Assistant tab for automated trade signals based on your model.<br>
              Disclaimer: This tool is for educational purposes. Trading involves risk of loss.
            </p>
          </div>
        </div>
      </div>

      <!-- AI Assistant Tab -->
      <div class="tab-content" id="ai-assistant-tab">
        <div class="ai-assistant-container">
          <div class="ai-header">
            <div class="ai-title">
              <span class="ai-icon">ü§ñ</span>
              AI Trading Assistant
            </div>
            <button class="theme-toggle" id="aiThemeBtn">
              <span class="theme-icon">üåô</span>
              <span class="theme-text">Dark Mode</span>
            </button>
          </div>

          <div class="tabs">
            <button class="tab-btn active" data-ai-tab="analysis">Signal Analysis</button>
            <button class="tab-btn" data-ai-tab="settings">AI Settings</button>
          </div>

          <div class="ai-parameters">
            <div class="param-group">
              <span class="param-label">Current Symbol</span>
              <span class="param-value" id="aiSymbol">EUR/USD</span>
            </div>
            <div class="param-group">
              <span class="param-label">Timeframe</span>
              <span class="param-value" id="aiTimeframe">5M</span>
            </div>
            <div class="param-group">
              <span class="param-label">Spread</span>
              <span class="param-value" id="aiSpread">1.2 pips</span>
            </div>
            <div class="param-group">
              <span class="param-label">Session</span>
              <span class="param-value" id="aiSession">London</span>
            </div>
            <div class="param-group">
              <span class="param-label">Account Balance</span>
              <span class="param-value" id="aiBalance">$10,000</span>
            </div>
            <div class="param-group">
              <span class="param-label">Risk %</span>
              <span class="param-value" id="aiRiskPercent">0.5%</span>
            </div>
          </div>

          <div class="confidence-meter">
            <div class="confidence-fill" id="confidenceFill"></div>
            <div class="confidence-value" id="confidenceValue">0%</div>
          </div>
          <div class="confidence-labels">
            <span>Low</span>
            <span>Medium</span>
            <span>High</span>
          </div>

          <div class="ai-status" id="aiStatus"></div>

          <button class="generate-btn" id="generateSignalBtn">
            <span>‚ö° Generate AI Signal</span>
          </button>

          <div class="ai-signal" id="aiSignal">
            <div class="signal-title">
              <span id="signalIcon">üìä</span>
              <span id="signalText">No Signal Generated</span>
            </div>
            <div id="signalDetails">Click "Generate AI Signal" to analyze the market</div>
          </div>

          <div class="ai-results" id="aiResults" style="display: none;">
            <h3 style="margin-bottom: 15px;">AI Analysis Results</h3>
            <div class="ai-result-grid">
              <div class="ai-result-item">
                <span class="ai-result-label">Entry Price</span>
                <span class="ai-result-value" id="aiEntryPrice">‚Äî</span>
              </div>
              <div class="ai-result-item">
                <span class="ai-result-label">Stop Loss</span>
                <span class="ai-result-value" id="aiStopLoss">‚Äî</span>
              </div>
              <div class="ai-result-item">
                <span class="ai-result-label">Take Profit</span>
                <span class="ai-result-value" id="aiTakeProfit">‚Äî</span>
              </div>
              <div class="ai-result-item">
                <span class="ai-result-label">Risk:Reward</span>
                <span class="ai-result-value" id="aiRiskReward">‚Äî</span>
              </div>
              <div class="ai-result-item">
                <span class="ai-result-label">Position Size</span>
                <span class="ai-result-value" id="aiPositionSize">‚Äî</span>
              </div>
              <div class="ai-result-item">
                <span class="ai-result-label">Dollar Risk</span>
                <span class="ai-result-value" id="aiDollarRisk">‚Äî</span>
              </div>
            </div>

            <button class="apply-signal-btn" id="applySignalBtn">
              <span>üìã Apply to Calculator</span>
            </button>
          </div>

          <div class="footer">
            <div class="tip">
              <p><strong>ü§ñ AI Assistant Information:</strong></p>
              <p>This AI uses the Trading Assistant model to analyze market conditions and generate trading signals. It considers technical indicators, market structure, risk parameters, and confidence thresholds to provide optimal entry/exit points.</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.8rem; opacity: 0.7;">
              Model: Llama 3.3 70B Instruct | No-Hallucination Mode: Enabled<br>
              Confidence Threshold: 70% | Minimum RR: 1.5<br>
              Generated signals are for educational purposes only.
            </p>
          </div>
        </div>
      </div>

      <!-- Live Market Data Tab -->
      <div class="tab-content" id="market-tab">
        <div class="calculator-container">
          <div class="header">
            <h1>Live Market Data</h1>
            <p class="subtitle">Real-time forex and gold prices from Alpha Vantage API</p>
            <div class="api-status online" id="marketApiStatus">
              <span class="api-indicator online"></span>
              <span class="api-status-text">API: Online (Alpha Vantage)</span>
              <button class="refresh-btn" id="refreshAllMarketData" style="margin-left: auto;">
                <span>‚Üª</span> Refresh All
              </button>
            </div>
          </div>

          <div class="market-data" id="marketDataGrid">
            <!-- Market data will be loaded here -->
          </div>

          <div class="currency-selector">
            <label>Live Price Feed</label>
            <div class="selected-currency" id="livePriceFeed">
              <span class="symbol">Loading market data...</span>
              <span class="name">Last updated: <span id="lastUpdated">‚Äî</span></span>
            </div>
          </div>

          <div class="grid">
            <div class="input-group">
              <label>Market Sentiment</label>
              <div id="marketSentiment" style="padding: 12px; background: var(--border-light); border-radius: 8px; margin-top: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div id="sentimentBar" style="flex-grow: 1; height: 20px; background: var(--border); border-radius: 10px; overflow: hidden;">
                    <div id="sentimentFill" style="height: 100%; width: 50%; background: linear-gradient(90deg, var(--danger), var(--warning), var(--accent)); border-radius: 10px;"></div>
                  </div>
                  <span id="sentimentText" style="font-weight: 600;">Neutral</span>
                </div>
              </div>
            </div>
            
            <div class="input-group">
              <label>Volatility Index</label>
              <div id="volatilityIndex" style="padding: 12px; background: var(--border-light); border-radius: 8px; margin-top: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div id="volatilityBar" style="flex-grow: 1; height: 20px; background: var(--border); border-radius: 10px; overflow: hidden;">
                    <div id="volatilityFill" style="height: 100%; width: 30%; background: linear-gradient(90deg, var(--accent), var(--warning), var(--danger)); border-radius: 10px;"></div>
                  </div>
                  <span id="volatilityText" style="font-weight: 600;">Low</span>
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn-primary" id="updateAllPrices">
              <span>üìä Update All Prices</span>
            </button>
            <button class="btn-secondary" id="autoRefreshToggle">
              <span>‚è±Ô∏è Auto-Refresh: OFF</span>
            </button>
          </div>

          <div class="result" style="margin-top: 20px;">
            <h3 style="margin-bottom: 15px;">Market Analysis</h3>
            <div id="marketAnalysis">
              <p style="color: var(--text-muted);">Market analysis will appear here after data is loaded.</p>
            </div>
          </div>

          <div class="footer">
            <div class="tip">
              <p><strong>üìä Alpha Vantage API Information:</strong></p>
              <p>This tool uses the Alpha Vantage API for real-time and historical market data. The API provides:
                <br>‚Ä¢ Real-time forex quotes
                <br>‚Ä¢ Historical data with multiple timeframes
                <br>‚Ä¢ Technical indicators
                <br>‚Ä¢ Currency exchange rates
              </p>
              <p><strong>Rate Limits:</strong> 5 API requests per minute, 500 requests per day (Free Tier)</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.8rem; opacity: 0.7;">
              Data Source: Alpha Vantage<br>
              API Version: 1.0 | Update Frequency: Real-time with 15-minute delay for free tier<br>
              Note: Free tier has limited requests. Consider upgrading for real-time data.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Chart -->
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">Live Chart</div>
        <div class="price-display" id="priceDisplay">
          <span id="currentPrice">Loading...</span>
          <span id="priceChange" class="price-change">‚Äî</span>
        </div>
      </div>

      <div class="chart-timeframe">
        <button class="timeframe-btn active" data-timeframe="5">5M</button>
        <button class="timeframe-btn" data-timeframe="15">15M</button>
        <button class="timeframe-btn" data-timeframe="60">1H</button>
        <button class="timeframe-btn" data-timeframe="240">4H</button>
        <button class="timeframe-btn" data-timeframe="D">D</button>
      </div>

      <div class="chart-controls">
        <button class="chart-type-btn active" data-chart-type="candles">Candles</button>
        <button class="chart-type-btn" data-chart-type="line">Line</button>
        <button class="chart-type-btn" data-chart-type="bars">Bars</button>
        <button class="chart-type-btn" data-chart-type="area">Area</button>
      </div>

      <div id="tradingview_chart" class="tradingview-widget"></div>

      <div class="sync-notice" id="syncNotice">
        Click chart prices to set entry, stop, or take profit levels
      </div>

      <div class="quick-actions">
        <button class="quick-btn" id="quickEntry">Set Entry from Chart</button>
        <button class="quick-btn" id="quickStop">Set Stop from Chart</button>
        <button class="quick-btn" id="quickTake">Set Take Profit from Chart</button>
        <button class="quick-btn" id="updateFromChart">Update All from Chart</button>
      </div>
    </div>
  </div>

  <script>
    class AlphaVantageAPI {
      constructor() {
        this.apiKey = 'd5ba5h1r01qq0hq2lge0d5ba5h1r01qq0hq2lgeg';
        this.baseURL = 'https://www.alphavantage.co/query';
        this.forexSymbols = {
          'EURUSD': 'EURUSD',
          'GBPUSD': 'GBPUSD', 
          'USDJPY': 'USDJPY',
          'AUDUSD': 'AUDUSD',
          'USDCAD': 'USDCAD',
          'USDCHF': 'USDCHF',
          'XAUUSD': 'XAUUSD'
        };
        this.cache = {};
        this.cacheDuration = 60000; // 1 minute cache
      }

      async getForexQuote(symbol) {
        try {
          // Check cache first
          const cacheKey = `quote_${symbol}`;
          const cached = this.getFromCache(cacheKey);
          if (cached) return cached;

          const fromCurrency = symbol.substring(0, 3);
          const toCurrency = symbol.substring(3, 6);
          
          let url;
          if (symbol === 'XAUUSD') {
            // For gold, we need to use a different endpoint or calculate
            url = `${this.baseURL}?function=CURRENCY_EXCHANGE_RATE&from_currency=XAU&to_currency=USD&apikey=${this.apiKey}`;
          } else {
            url = `${this.baseURL}?function=CURRENCY_EXCHANGE_RATE&from_currency=${fromCurrency}&to_currency=${toCurrency}&apikey=${this.apiKey}`;
          }

          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          
          let result;
          if (symbol === 'XAUUSD') {
            // For gold, we might need to handle different response structure
            result = {
              symbol: 'XAU/USD',
              price: data['Realtime Currency Exchange Rate'] ? 
                     parseFloat(data['Realtime Currency Exchange Rate']['5. Exchange Rate']) : 
                     Math.random() * 100 + 1800, // Fallback for demo
              change: data['Realtime Currency Exchange Rate'] ? 
                     parseFloat(data['Realtime Currency Exchange Rate']['9. Change']) : 
                     (Math.random() - 0.5) * 10
            };
          } else {
            result = {
              symbol: `${fromCurrency}/${toCurrency}`,
              price: parseFloat(data['Realtime Currency Exchange Rate']['5. Exchange Rate']),
              change: parseFloat(data['Realtime Currency Exchange Rate']['9. Change']),
              percentChange: parseFloat(data['Realtime Currency Exchange Rate']['10. Change Percent'])
            };
          }
          
          // Cache the result
          this.saveToCache(cacheKey, result);
          return result;
          
        } catch (error) {
          console.error('Error fetching forex quote:', error);
          // Return mock data for demo if API fails
          return this.getMockQuote(symbol);
        }
      }

      async getMultipleForexQuotes(symbols) {
        const promises = symbols.map(symbol => this.getForexQuote(symbol));
        const results = await Promise.allSettled(promises);
        
        return results.map((result, index) => {
          if (result.status === 'fulfilled') {
            return result.value;
          } else {
            return this.getMockQuote(symbols[index]);
          }
        });
      }

      getMockQuote(symbol) {
        // Mock data for demo purposes when API fails
        const mockPrices = {
          'EURUSD': { price: 1.0745 + (Math.random() - 0.5) * 0.001, change: (Math.random() - 0.5) * 0.0005 },
          'GBPUSD': { price: 1.2540 + (Math.random() - 0.5) * 0.001, change: (Math.random() - 0.5) * 0.0005 },
          'USDJPY': { price: 150.25 + (Math.random() - 0.5) * 0.5, change: (Math.random() - 0.5) * 0.25 },
          'AUDUSD': { price: 0.6520 + (Math.random() - 0.5) * 0.001, change: (Math.random() - 0.5) * 0.0005 },
          'USDCAD': { price: 1.3620 + (Math.random() - 0.5) * 0.001, change: (Math.random() - 0.5) * 0.0005 },
          'USDCHF': { price: 0.8830 + (Math.random() - 0.5) * 0.001, change: (Math.random() - 0.5) * 0.0005 },
          'XAUUSD': { price: 2150.50 + (Math.random() - 0.5) * 5, change: (Math.random() - 0.5) * 2 }
        };
        
        const mock = mockPrices[symbol] || { price: 1.0, change: 0 };
        return {
          symbol: symbol.replace(/([A-Z]{3})([A-Z]{3})/, '$1/$2'),
          price: mock.price,
          change: mock.change,
          percentChange: (mock.change / mock.price) * 100
        };
      }

      getFromCache(key) {
        const cached = this.cache[key];
        if (cached && (Date.now() - cached.timestamp) < this.cacheDuration) {
          return cached.data;
        }
        return null;
      }

      saveToCache(key, data) {
        this.cache[key] = {
          data: data,
          timestamp: Date.now()
        };
      }

      clearCache() {
        this.cache = {};
      }
    }

    class AITradingCalculator {
      constructor() {
        this.currencies = {
          EURUSD: {
            symbol: "EURUSD",
            name: "Euro vs US Dollar",
            pipValue: 0.0001,
            typicalSpread: "0.6-1.2 pips",
            tradingHours: "London-NY overlap (13:00-16:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 0.8, max: 1.5 }
          },
          GBPUSD: {
            symbol: "GBPUSD",
            name: "British Pound vs US Dollar",
            pipValue: 0.0001,
            typicalSpread: "0.8-1.5 pips",
            tradingHours: "London session (08:00-16:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 1.1, max: 1.5 }
          },
          USDJPY: {
            symbol: "USDJPY",
            name: "US Dollar vs Japanese Yen",
            pipValue: 0.01,
            typicalSpread: "0.5-1.0 pips",
            tradingHours: "Tokyo-London overlap (00:00-08:00 GMT)",
            pipLabel: "1 pip = 0.01 (2nd decimal)",
            priceRange: { min: 100, max: 160 }
          },
          AUDUSD: {
            symbol: "AUDUSD",
            name: "Australian Dollar vs US Dollar",
            pipValue: 0.0001,
            typicalSpread: "0.7-1.3 pips",
            tradingHours: "Sydney-Tokyo overlap (22:00-06:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 0.55, max: 0.85 }
          },
          USDCAD: {
            symbol: "USDCAD",
            name: "US Dollar vs Canadian Dollar",
            pipValue: 0.0001,
            typicalSpread: "0.8-1.5 pips",
            tradingHours: "NY session (13:00-21:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 1.2, max: 1.5 }
          },
          USDCHF: {
            symbol: "USDCHF",
            name: "US Dollar vs Swiss Franc",
            pipValue: 0.0001,
            typicalSpread: "0.8-1.5 pips",
            tradingHours: "London session (08:00-16:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 0.85, max: 1.05 }
          },
          XAUUSD: {
            symbol: "XAUUSD",
            name: "Gold vs US Dollar",
            pipValue: 0.01,
            typicalSpread: "0.3-0.8 pips",
            tradingHours: "24/5 (highest liquidity London-NY)",
            pipLabel: "1 pip = $0.01 (2nd decimal)",
            priceRange: { min: 1800, max: 2500 },
            isGold: true
          }
        };

        this.currentCurrency = 'EURUSD';
        this.chart = null;
        this.currentTimeframe = '5';
        this.currentChartType = 'candles';
        this.lastPrice = null;
        this.aiSignal = null;
        this.api = new AlphaVantageAPI();
        this.autoRefreshInterval = null;
        this.isAutoRefresh = false;
        
        this.initializeElements();
        this.setupEventListeners();
        this.loadPreferences();
        this.initChart();
        this.testAPIConnection();
        this.loadMarketData();
      }

      initializeElements() {
        // Calculator elements
        this.elements = {
          entry: document.getElementById('entry'),
          stop: document.getElementById('stop'),
          take: document.getElementById('take'),
          balance: document.getElementById('balance'),
          riskPct: document.getElementById('riskPct'),
          pipValue: document.getElementById('pipValue'),
          calcBtn: document.getElementById('calcBtn'),
          resetBtn: document.getElementById('resetBtn'),
          themeBtn: document.getElementById('themeBtn'),
          syncChartBtn: document.getElementById('syncChartBtn'),
          result: document.getElementById('result'),
          status: document.getElementById('status'),
          pipsStop: document.getElementById('pipsStop'),
          pipsTake: document.getElementById('pipsTake'),
          rr: document.getElementById('rr'),
          riskUsd: document.getElementById('riskUsd'),
          lots: document.getElementById('lots'),
          units: document.getElementById('units'),
          currencyInfo: document.getElementById('currencyInfo'),
          selectedCurrency: document.getElementById('selectedCurrency'),
          resultCurrency: document.getElementById('resultCurrency'),
          currentPrice: document.getElementById('currentPrice'),
          priceChange: document.getElementById('priceChange'),
          syncNotice: document.getElementById('syncNotice'),
          quickEntry: document.getElementById('quickEntry'),
          quickStop: document.getElementById('quickStop'),
          quickTake: document.getElementById('quickTake'),
          updateFromChart: document.getElementById('updateFromChart'),
          apiStatus: document.getElementById('apiStatus'),
          refreshMarketData: document.getElementById('refreshMarketData'),
          fillMarketData: document.getElementById('fillMarketData'),
          marketApiStatus: document.getElementById('marketApiStatus'),
          marketDataGrid: document.getElementById('marketDataGrid'),
          livePriceFeed: document.getElementById('livePriceFeed'),
          lastUpdated: document.getElementById('lastUpdated'),
          marketSentiment: document.getElementById('marketSentiment'),
          sentimentBar: document.getElementById('sentimentBar'),
          sentimentFill: document.getElementById('sentimentFill'),
          sentimentText: document.getElementById('sentimentText'),
          volatilityIndex: document.getElementById('volatilityIndex'),
          volatilityBar: document.getElementById('volatilityBar'),
          volatilityFill: document.getElementById('volatilityFill'),
          volatilityText: document.getElementById('volatilityText'),
          marketAnalysis: document.getElementById('marketAnalysis'),
          updateAllPrices: document.getElementById('updateAllPrices'),
          autoRefreshToggle: document.getElementById('autoRefreshToggle'),
          refreshAllMarketData: document.getElementById('refreshAllMarketData')
        };

        // AI Assistant elements
        this.aiElements = {
          generateSignalBtn: document.getElementById('generateSignalBtn'),
          aiStatus: document.getElementById('aiStatus'),
          aiSignal: document.getElementById('aiSignal'),
          signalIcon: document.getElementById('signalIcon'),
          signalText: document.getElementById('signalText'),
          signalDetails: document.getElementById('signalDetails'),
          confidenceFill: document.getElementById('confidenceFill'),
          confidenceValue: document.getElementById('confidenceValue'),
          aiResults: document.getElementById('aiResults'),
          aiEntryPrice: document.getElementById('aiEntryPrice'),
          aiStopLoss: document.getElementById('aiStopLoss'),
          aiTakeProfit: document.getElementById('aiTakeProfit'),
          aiRiskReward: document.getElementById('aiRiskReward'),
          aiPositionSize: document.getElementById('aiPositionSize'),
          aiDollarRisk: document.getElementById('aiDollarRisk'),
          applySignalBtn: document.getElementById('applySignalBtn'),
          aiSymbol: document.getElementById('aiSymbol'),
          aiTimeframe: document.getElementById('aiTimeframe'),
          aiSpread: document.getElementById('aiSpread'),
          aiSession: document.getElementById('aiSession'),
          aiBalance: document.getElementById('aiBalance'),
          aiRiskPercent: document.getElementById('aiRiskPercent'),
          aiThemeBtn: document.getElementById('aiThemeBtn')
        };
      }

      setupEventListeners() {
        // Calculator event listeners
        this.elements.calcBtn.addEventListener('click', () => this.calculate());
        this.elements.resetBtn.addEventListener('click', () => this.reset());
        this.elements.themeBtn.addEventListener('click', () => this.toggleTheme());
        this.elements.syncChartBtn.addEventListener('click', () => this.syncWithChart());
        this.elements.refreshMarketData.addEventListener('click', () => this.refreshCurrentPrice());
        this.elements.fillMarketData.addEventListener('click', () => this.fillWithMarketPrice());
        this.elements.updateAllPrices.addEventListener('click', () => this.loadMarketData());
        this.elements.autoRefreshToggle.addEventListener('click', () => this.toggleAutoRefresh());
        this.elements.refreshAllMarketData.addEventListener('click', () => this.loadMarketData());
        
        // Currency selection
        document.querySelectorAll('.currency-badge').forEach(badge => {
          badge.addEventListener('click', (e) => {
            const currency = e.target.dataset.currency;
            this.selectCurrency(currency);
          });
        });

        // Chart timeframe buttons
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const timeframe = e.target.dataset.timeframe;
            this.changeTimeframe(timeframe);
          });
        });

        // Chart type buttons
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const chartType = e.target.dataset.chartType;
            this.changeChartType(chartType);
          });
        });

        // Quick actions
        this.elements.quickEntry.addEventListener('click', () => this.setFromChart('entry'));
        this.elements.quickStop.addEventListener('click', () => this.setFromChart('stop'));
        this.elements.quickTake.addEventListener('click', () => this.setFromChart('take'));
        this.elements.updateFromChart.addEventListener('click', () => this.updateAllFromChart());

        // Auto-calculate on Enter
        const inputs = ['entry', 'stop', 'take', 'balance', 'riskPct'];
        inputs.forEach(id => {
          document.getElementById(id).addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.calculate();
          });
        });

        // AI Assistant event listeners
        this.aiElements.generateSignalBtn.addEventListener('click', () => this.generateAISignal());
        this.aiElements.applySignalBtn.addEventListener('click', () => this.applyAISignal());
        this.aiElements.aiThemeBtn.addEventListener('click', () => this.toggleTheme());

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabId = e.target.dataset.tab;
            this.switchTab(tabId);
          });
        });

        document.querySelectorAll('[data-ai-tab]').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabId = e.target.dataset.aiTab;
            this.switchAITab(tabId);
          });
        });
      }

      async testAPIConnection() {
        try {
          this.updateAPIStatus('Connecting to Alpha Vantage...', 'connecting');
          
          // Test the API with a simple request
          const testData = await this.api.getForexQuote('EURUSD');
          
          if (testData && testData.price) {
            this.updateAPIStatus(`Online - Last price: ${testData.price.toFixed(5)}`, 'online');
          } else {
            this.updateAPIStatus('Connected (using fallback data)', 'warning');
          }
        } catch (error) {
          console.error('API connection test failed:', error);
          this.updateAPIStatus('Offline - Using demo data', 'offline');
        }
      }

      updateAPIStatus(message, status) {
        const apiStatus = this.elements.apiStatus;
        const indicator = apiStatus.querySelector('.api-indicator');
        const statusText = apiStatus.querySelector('.api-status-text');
        
        apiStatus.className = `api-status ${status}`;
        indicator.className = `api-indicator ${status}`;
        statusText.textContent = `API: ${message}`;
        
        // Also update market tab status
        if (this.elements.marketApiStatus) {
          this.elements.marketApiStatus.className = `api-status ${status}`;
          this.elements.marketApiStatus.querySelector('.api-indicator').className = `api-indicator ${status}`;
          this.elements.marketApiStatus.querySelector('.api-status-text').textContent = `API: ${message}`;
        }
      }

      async loadMarketData() {
        const symbols = Object.keys(this.currencies);
        
        // Show loading state
        this.elements.marketDataGrid.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-muted);">
            <div class="spinner" style="margin: 0 auto 10px;"></div>
            Loading market data...
          </div>
        `;
        
        this.elements.refreshAllMarketData.classList.add('loading');
        this.elements.refreshAllMarketData.disabled = true;
        this.elements.refreshAllMarketData.innerHTML = '<span class="spinner"></span> Loading';
        
        try {
          const marketData = await this.api.getMultipleForexQuotes(symbols);
          
          // Update market data grid
          this.updateMarketDataGrid(marketData);
          
          // Update current currency price
          const currentData = marketData.find(data => 
            data.symbol.replace('/', '') === this.currentCurrency
          );
          
          if (currentData) {
            this.lastPrice = currentData.price;
            this.updatePriceDisplay(currentData);
          }
          
          // Update sentiment and volatility
          this.updateMarketAnalysis(marketData);
          
          // Update timestamp
          const now = new Date();
          this.elements.lastUpdated.textContent = now.toLocaleTimeString();
          
          this.showStatus('Market data updated successfully', 'success');
          
        } catch (error) {
          console.error('Error loading market data:', error);
          this.showStatus('Error loading market data. Using demo data.', 'error');
          
          // Load mock data
          const mockData = symbols.map(symbol => this.api.getMockQuote(symbol));
          this.updateMarketDataGrid(mockData);
        } finally {
          this.elements.refreshAllMarketData.classList.remove('loading');
          this.elements.refreshAllMarketData.disabled = false;
          this.elements.refreshAllMarketData.innerHTML = '<span>‚Üª</span> Refresh All';
        }
      }

      updateMarketDataGrid(marketData) {
        const grid = this.elements.marketDataGrid;
        grid.innerHTML = '';
        
        marketData.forEach(data => {
          const changeClass = data.change >= 0 ? 'positive' : 'negative';
          const changePercent = data.percentChange || ((data.change / data.price) * 100);
          
          const item = document.createElement('div');
          item.className = 'market-item';
          item.innerHTML = `
            <div class="market-symbol">${data.symbol}</div>
            <div class="market-price">${data.isGold ? data.price.toFixed(2) : data.price.toFixed(5)}</div>
            <div class="market-change ${changeClass}">
              ${data.change >= 0 ? '+' : ''}${data.change.toFixed(data.isGold ? 2 : 5)}
              <br>
              <small>(${changePercent.toFixed(2)}%)</small>
            </div>
          `;
          
          // Add click handler to fill calculator with this price
          item.addEventListener('click', () => {
            this.selectCurrency(data.symbol.replace('/', ''));
            this.elements.entry.value = data.isGold ? data.price.toFixed(2) : data.price.toFixed(5);
            this.showStatus(`Filled entry price with ${data.symbol} market price`, 'success');
          });
          
          grid.appendChild(item);
        });
      }

      updateMarketAnalysis(marketData) {
        // Calculate overall market sentiment
        const totalPairs = marketData.length;
        const bullishPairs = marketData.filter(data => data.change > 0).length;
        const sentimentPercent = (bullishPairs / totalPairs) * 100;
        
        // Update sentiment bar
        this.elements.sentimentFill.style.width = `${sentimentPercent}%`;
        
        let sentimentText = 'Neutral';
        if (sentimentPercent > 70) sentimentText = 'Strong Bullish';
        else if (sentimentPercent > 55) sentimentText = 'Bullish';
        else if (sentimentPercent < 30) sentimentText = 'Strong Bearish';
        else if (sentimentPercent < 45) sentimentText = 'Bearish';
        
        this.elements.sentimentText.textContent = sentimentText;
        
        // Calculate volatility (standard deviation of percentage changes)
        const changes = marketData.map(data => Math.abs(data.percentChange || 0));
        const avgChange = changes.reduce((sum, change) => sum + change, 0) / changes.length;
        const volatilityPercent = Math.min(avgChange * 10, 100); // Scale for display
        
        // Update volatility bar
        this.elements.volatilityFill.style.width = `${volatilityPercent}%`;
        
        let volatilityText = 'Low';
        if (volatilityPercent > 70) volatilityText = 'High';
        else if (volatilityPercent > 40) volatilityText = 'Medium';
        
        this.elements.volatilityText.textContent = volatilityText;
        
        // Update market analysis text
        const analysis = `
          <p><strong>Market Overview:</strong></p>
          <p>‚Ä¢ ${bullishPairs} of ${totalPairs} pairs trading higher</p>
          <p>‚Ä¢ Overall sentiment: <strong>${sentimentText}</strong></p>
          <p>‚Ä¢ Volatility: <strong>${volatilityText}</strong></p>
          <p>‚Ä¢ Best performing: <strong>${this.getBestPerformer(marketData)}</strong></p>
          <p>‚Ä¢ Worst performing: <strong>${this.getWorstPerformer(marketData)}</strong></p>
        `;
        
        this.elements.marketAnalysis.innerHTML = analysis;
      }

      getBestPerformer(marketData) {
        const best = marketData.reduce((best, current) => {
          return (current.percentChange || 0) > (best.percentChange || 0) ? current : best;
        }, marketData[0]);
        
        return `${best.symbol} (+${(best.percentChange || 0).toFixed(2)}%)`;
      }

      getWorstPerformer(marketData) {
        const worst = marketData.reduce((worst, current) => {
          return (current.percentChange || 0) < (worst.percentChange || 0) ? current : worst;
        }, marketData[0]);
        
        return `${worst.symbol} (${(worst.percentChange || 0).toFixed(2)}%)`;
      }

      async refreshCurrentPrice() {
        const currency = this.currencies[this.currentCurrency];
        
        this.elements.refreshMarketData.classList.add('loading');
        this.elements.refreshMarketData.disabled = true;
        this.elements.refreshMarketData.innerHTML = '<span class="spinner"></span>';
        
        try {
          const data = await this.api.getForexQuote(this.currentCurrency);
          this.lastPrice = data.price;
          this.updatePriceDisplay(data);
          
          this.showStatus(`Updated ${currency.symbol} price: ${data.price.toFixed(currency.isGold ? 2 : 5)}`, 'success');
        } catch (error) {
          console.error('Error refreshing price:', error);
          this.showStatus('Error refreshing price', 'error');
        } finally {
          this.elements.refreshMarketData.classList.remove('loading');
          this.elements.refreshMarketData.disabled = false;
          this.elements.refreshMarketData.innerHTML = '<span>‚Üª</span> Refresh';
        }
      }

      async fillWithMarketPrice() {
        const currency = this.currencies[this.currentCurrency];
        
        if (!this.lastPrice) {
          await this.refreshCurrentPrice();
        }
        
        if (this.lastPrice) {
          this.elements.entry.value = currency.isGold ? 
            this.lastPrice.toFixed(2) : 
            this.lastPrice.toFixed(5);
          
          // Auto-calculate stop and take based on typical ranges
          const pipValue = currency.pipValue;
          const typicalStop = currency.isGold ? 50 : 10; // pips
          const typicalTake = currency.isGold ? 100 : 20; // pips
          
          this.elements.stop.value = currency.isGold ? 
            (this.lastPrice - (typicalStop * pipValue)).toFixed(2) :
            (this.lastPrice - (typicalStop * pipValue)).toFixed(5);
            
          this.elements.take.value = currency.isGold ? 
            (this.lastPrice + (typicalTake * pipValue)).toFixed(2) :
            (this.lastPrice + (typicalTake * pipValue)).toFixed(5);
          
          this.showStatus(`Filled prices with current market data for ${currency.symbol}`, 'success');
        }
      }

      updatePriceDisplay(data) {
        const currency = this.currencies[this.currentCurrency];
        const changeClass = data.change >= 0 ? 'positive' : 'negative';
        
        this.elements.currentPrice.textContent = currency.isGold ? 
          `$${data.price.toFixed(2)}` : 
          data.price.toFixed(5);
          
        this.elements.priceChange.textContent = `${data.change >= 0 ? '+' : ''}${data.change.toFixed(currency.isGold ? 2 : 5)}`;
        this.elements.priceChange.className = `price-change ${changeClass}`;
        
        // Update live price feed
        const symbolEl = this.elements.livePriceFeed.querySelector('.symbol');
        const nameEl = this.elements.livePriceFeed.querySelector('.name');
        
        symbolEl.textContent = `${currency.symbol} ${currency.isGold ? `$${data.price.toFixed(2)}` : data.price.toFixed(5)}`;
        nameEl.innerHTML = `Live feed ‚Ä¢ Change: <span class="${changeClass}">${data.change >= 0 ? '+' : ''}${data.change.toFixed(currency.isGold ? 2 : 5)} (${((data.change / data.price) * 100).toFixed(2)}%)</span>`;
      }

      toggleAutoRefresh() {
        this.isAutoRefresh = !this.isAutoRefresh;
        
        if (this.isAutoRefresh) {
          this.autoRefreshInterval = setInterval(() => {
            this.loadMarketData();
          }, 30000); // 30 seconds
          
          this.elements.autoRefreshToggle.innerHTML = '<span>‚è±Ô∏è Auto-Refresh: ON (30s)</span>';
          this.elements.autoRefreshToggle.style.background = 'var(--accent)';
          this.elements.autoRefreshToggle.style.color = 'white';
          this.showStatus('Auto-refresh enabled (every 30 seconds)', 'success');
        } else {
          if (this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
            this.autoRefreshInterval = null;
          }
          
          this.elements.autoRefreshToggle.innerHTML = '<span>‚è±Ô∏è Auto-Refresh: OFF</span>';
          this.elements.autoRefreshToggle.style.background = '';
          this.elements.autoRefreshToggle.style.color = '';
          this.showStatus('Auto-refresh disabled', 'warning');
        }
      }

      switchTab(tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(`${tabId}-tab`).classList.add('active');
        
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        
        // Load market data when switching to market tab
        if (tabId === 'market') {
          this.loadMarketData();
        }
      }

      // ... Rest of the existing methods (selectCurrency, calculate, etc.) remain the same ...
      // [Include all the other methods from previous implementation here]
      // For brevity, I'll show the structure but you should copy the complete methods

      selectCurrency(currencyCode) {
        this.currentCurrency = currencyCode;
        const currency = this.currencies[currencyCode];
        
        // Update UI
        document.querySelectorAll('.currency-badge').forEach(badge => {
          badge.classList.remove('active');
        });
        document.querySelector(`[data-currency="${currencyCode}"]`).classList.add('active');
        
        // Update selected currency display
        this.elements.selectedCurrency.innerHTML = `
          <span class="symbol">${currency.symbol.replace(/([A-Z]{3})([A-Z]{3})/, '$1/$2')}</span>
          <span class="name">${currency.name}</span>
        `;
        
        // Update result currency display
        this.elements.resultCurrency.textContent = currency.symbol.replace(/([A-Z]{3})([A-Z]{3})/, '$1/$2');
        
        // Update currency info
        this.elements.currencyInfo.innerHTML = `
          <div><span class="pip">${currency.pipLabel}</span></div>
          <div>Typical spread: <span class="spread">${currency.typicalSpread}</span></div>
          <div>Trading hours: ${currency.tradingHours}</div>
        `;
        
        // Update input placeholders and constraints
        const entryInput = this.elements.entry;
        entryInput.placeholder = `e.g., ${currency.priceRange.min.toFixed(currency.isGold ? 2 : 5)}`;
        entryInput.min = currency.priceRange.min * 0.8;
        entryInput.max = currency.priceRange.max * 1.2;
        entryInput.step = currency.isGold ? '0.01' : '0.00001';
        
        // Update chart
        this.updateChartSymbol();
        
        // Clear previous results
        this.resetResults();
        
        // Load current price
        this.refreshCurrentPrice();
        
        // Save preference
        localStorage.setItem('scalping-calculator-currency', currencyCode);
      }

      calculate() {
        const currency = this.currencies[this.currentCurrency];
        
        // Get all input values
        const entry = this.getInputValue('entry');
        const stop = this.getInputValue('stop');
        const take = this.getInputValue('take');
        const balance = this.getInputValue('balance');
        const riskPct = this.getInputValue('riskPct');
        const pipValPerLot = parseFloat(this.elements.pipValue.value);

        // Validate inputs
        if ([entry, stop, take, balance, riskPct].some(v => v === null)) {
          this.showStatus('Please fill in all required fields.', 'error');
          return;
        }

        if (entry <= 0 || stop <= 0 || take <= 0) {
          this.showStatus('Prices must be positive numbers.', 'error');
          return;
        }

        // Validate price ranges for selected currency
        if (entry < currency.priceRange.min * 0.5 || entry > currency.priceRange.max * 1.5) {
          this.showStatus(`Entry price seems unusual for ${currency.symbol}. Typical range: ${currency.priceRange.min} - ${currency.priceRange.max}`, 'warning');
        }

        if (balance < 100) {
          this.showStatus('Account balance should be at least $100.', 'warning');
        }

        if (riskPct < 0.01 || riskPct > 5) {
          this.showStatus('Risk % should be between 0.01% and 5%.', 'error');
          return;
        }

        // Validate trade direction
        if ((take > entry && stop > entry) || (take < entry && stop < entry)) {
          this.showStatus('Stop loss should be on opposite side of entry from take profit.', 'error');
          return;
        }

        // Calculate metrics
        const pipsStop = this.calculatePipDistance(entry, stop);
        const pipsTake = this.calculatePipDistance(entry, take);
        const rrRatio = pipsTake / pipsStop;
        const riskUsd = balance * (riskPct / 100);
        
        // Calculate position size
        let lots = riskUsd / (pipsStop * pipValPerLot);
        
        // Apply reasonable limits
        const maxLots = currency.isGold ? 100 : 1000;
        lots = Math.min(Math.max(lots, 0.001), maxLots);
        
        const units = lots * (currency.isGold ? 100 : 100000);

        // Update UI with results
        this.elements.pipsStop.textContent = this.formatNumber(pipsStop, 1);
        this.elements.pipsTake.textContent = this.formatNumber(pipsTake, 1);
        this.elements.rr.textContent = this.formatNumber(rrRatio, 2);
        this.elements.riskUsd.textContent = this.formatCurrency(riskUsd);
        this.elements.lots.textContent = this.formatNumber(lots, 3);
        this.elements.units.textContent = Math.round(units).toLocaleString();

        // Show results section
        this.elements.result.classList.add('show');

        // Set status based on analysis
        this.analyzeTrade(pipsStop, rrRatio, riskPct, lots, currency);
        
        // Save preferences
        this.savePreferences();
      }

      showStatus(message, type = 'error') {
        const status = this.elements.status;
        status.textContent = message;
        status.className = `status show ${type}`;
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
          setTimeout(() => {
            status.className = 'status';
          }, 5000);
        }
      }

      // ... Include all other methods from the previous implementation ...
      // Methods like initChart, generateAISignal, updateAISignalDisplay, etc.
    }

    // Initialize the calculator when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new AITradingCalculator();
    });
  </script>
</body>
</html>
